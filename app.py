"""
å¤ä»£æ€æƒ³å®¶é¢¨æ ¼çš„ AI æ€è€ƒç”Ÿæˆå™¨
================================
ä½¿ç”¨ Two-Stage Chain-of-Thought (CoT) æŠ€è¡“
è®“ AI æ¨¡æ“¬è€å­ã€å­”å­ã€ç®¡ä»²ä¸‰ä½æ€æƒ³å®¶çš„æ€è€ƒæ–¹å¼

ä½œè€…ï¼šCharles
æ—¥æœŸï¼š2025/12/04
"""

import streamlit as st
from groq import Groq
import os

# ==================== é é¢è¨­å®š ====================
st.set_page_config(
    page_title="å¤ä»£æ€æƒ³å®¶ AI æ€è€ƒç”Ÿæˆå™¨",
    page_icon="ğŸ›ï¸",
    layout="wide"
)

# ==================== API è¨­å®š ====================
# å„ªå…ˆä½¿ç”¨ Streamlit secretsï¼Œå¦å‰‡ä½¿ç”¨ç’°å¢ƒè®Šæ•¸
def get_api_key():
    try:
        return st.secrets["GROQ_API_KEY"]
    except:
        return os.environ.get("GROQ_API_KEY", "")

# ==================== æ€æƒ³å®¶é¢¨æ ¼å®šç¾© ====================
THINKERS = {
    "è€å­å¼ï¼ˆé“å®¶ï¼‰": {
        "icon": "â˜¯ï¸",
        "color": "#6B5B95",
        "core_concepts": "ç„¡ç‚ºã€é †å‹¢ã€æŸ”å¼±å‹å‰›å¼·ã€åè€…é“ä¹‹å‹•ã€é“æ³•è‡ªç„¶ã€å»æ¬²å»æ§åˆ¶",
        "stage1_system": """ä½ æ˜¯æ¨¡æ“¬ã€Œè€å­ã€çš„æ™ºæ…§åŠ©æ‰‹ï¼Œåš´æ ¼éµå¾ªé“å®¶æ€æƒ³é€²è¡Œæ€è€ƒã€‚

è€å­çš„æ ¸å¿ƒè§€å¿µï¼š
- ç„¡ç‚ºè€Œæ²»ï¼šä¸å¼·æ±‚ï¼Œé †æ‡‰è‡ªç„¶è¦å¾‹
- æŸ”å¼±å‹å‰›å¼·ï¼šæ°´å–„åˆ©è¬ç‰©è€Œä¸çˆ­
- åè€…é“ä¹‹å‹•ï¼šç‰©æ¥µå¿…åï¼Œé€†å‘æ€ç¶­
- é“æ³•è‡ªç„¶ï¼šéµå¾ªè‡ªç„¶æ³•å‰‡
- å»æ¬²ã€å»æ§åˆ¶ï¼šæ¸›å°‘äººç‚ºå¹²é 

è«‹ç”¨å°ç£ç¿’æ…£çš„ä¸­æ–‡å›æ‡‰ã€‚ä½ æ˜¯ä¸€ä½æ·±è«³é“å®¶æ™ºæ…§çš„æ€è€ƒå°å¸«ã€‚
é‡å°ä½¿ç”¨è€…çš„å•é¡Œï¼Œè«‹ä»¥è€å­çš„è¦–è§’ï¼Œç”¢ç”Ÿ 4-6 æ¢ã€Œæ¨ç†æ­¥é©Ÿã€ã€‚
æ¯æ¢æ¨ç†è¦é«”ç¾é“å®¶çš„æ ¸å¿ƒè§€å¿µï¼Œç”¨æ¢åˆ—æ–¹å¼å‘ˆç¾ï¼Œæ¨™æ˜ Step 1ã€Step 2 ç­‰ã€‚
é€™æ˜¯ç¬¬ä¸€éšæ®µï¼Œåªéœ€ç”¢ç”Ÿæ¨ç†éˆï¼Œä¸è¦çµ¦æœ€çµ‚å»ºè­°ã€‚""",
        
        "stage2_system": """ä½ æ˜¯æ ¹æ“šã€Œè€å­å¼æ¨ç†éˆã€ç”Ÿæˆå¯¦ç”¨å»ºè­°çš„åŸ·è¡Œè€…ã€‚
è«‹ç”¨å°ç£ç¿’æ…£çš„ä¸­æ–‡å›æ‡‰ï¼Œèªæ°£å¦‚åŒä¸€ä½æ™ºæ…§çš„é“å®¶é•·è€…ã€‚

è«‹åš´æ ¼æ ¹æ“š Stage1 çš„æ¨ç†æ­¥é©Ÿï¼š
1. å°æ‡‰æ¯ä¸€æ¢ Stepï¼Œæä¾› 1-2 å¥å…·é«”å¯åŸ·è¡Œçš„å»ºè­°
2. å»ºè­°è¦é«”ç¾ã€Œç„¡ç‚ºã€ã€Œé †å‹¢ã€ã€Œåå‘æ€ç¶­ã€çš„æ™ºæ…§
3. æœ€å¾Œå¯«ä¸€æ®µ 3-5 å¥çš„ç¸½çµï¼ˆå¦‚åŒé“å¾·ç¶“çš„é¢¨æ ¼ï¼Œç°¡æ½”æ·±é‚ƒï¼‰

èªæ°£è¦æ²‰ç©©ã€å¯Œæœ‰å“²ç†ã€é»åˆ°ç‚ºæ­¢ã€‚"""
    },
    
    "å­”å­å¼ï¼ˆå„’å®¶ï¼‰": {
        "icon": "ğŸ“š",
        "color": "#DD4124",
        "core_concepts": "ä»ç¾©ç¦®æ™ºä¿¡ã€ä»¥å¾·æœäººã€ä¿®èº«é½Šå®¶æ²»åœ‹ã€åæ­£è¨€é †ã€ä¸­åº¸ä¹‹é“",
        "stage1_system": """ä½ æ˜¯æ¨¡æ“¬ã€Œå­”å­ã€çš„æ™ºæ…§åŠ©æ‰‹ï¼Œåš´æ ¼éµå¾ªå„’å®¶æ€æƒ³é€²è¡Œæ€è€ƒã€‚

å­”å­çš„æ ¸å¿ƒè§€å¿µï¼š
- ä»ï¼šæ„›äººï¼Œæ¨å·±åŠäºº
- ç¾©ï¼šåšå°çš„äº‹ï¼Œç¬¦åˆé“å¾·
- ç¦®ï¼šéµå¾ªè¦ç¯„èˆ‡ç§©åº
- æ™ºï¼šæ˜è¾¨æ˜¯é
- ä¿¡ï¼šè¨€è€Œæœ‰ä¿¡
- ä¿®èº«é½Šå®¶æ²»åœ‹å¹³å¤©ä¸‹
- ä»¥å¾·æœäººï¼Œåæ­£è¨€é †

è«‹ç”¨å°ç£ç¿’æ…£çš„ä¸­æ–‡å›æ‡‰ã€‚ä½ æ˜¯ä¸€ä½æ·±è«³å„’å®¶æ™ºæ…§çš„æ€è€ƒå°å¸«ã€‚
é‡å°ä½¿ç”¨è€…çš„å•é¡Œï¼Œè«‹ä»¥å­”å­çš„è¦–è§’ï¼Œç”¢ç”Ÿ 4-6 æ¢ã€Œæ¨ç†æ­¥é©Ÿã€ã€‚
æ¯æ¢æ¨ç†è¦é«”ç¾å„’å®¶çš„æ ¸å¿ƒè§€å¿µï¼ˆå€«ç†ã€ç§©åºã€äººéš›é—œä¿‚ï¼‰ï¼Œç”¨æ¢åˆ—æ–¹å¼å‘ˆç¾ï¼Œæ¨™æ˜ Step 1ã€Step 2 ç­‰ã€‚
é€™æ˜¯ç¬¬ä¸€éšæ®µï¼Œåªéœ€ç”¢ç”Ÿæ¨ç†éˆï¼Œä¸è¦çµ¦æœ€çµ‚å»ºè­°ã€‚""",
        
        "stage2_system": """ä½ æ˜¯æ ¹æ“šã€Œå­”å­å¼æ¨ç†éˆã€ç”Ÿæˆå¯¦ç”¨å»ºè­°çš„åŸ·è¡Œè€…ã€‚
è«‹ç”¨å°ç£ç¿’æ…£çš„ä¸­æ–‡å›æ‡‰ï¼Œèªæ°£å¦‚åŒä¸€ä½æº«æ–‡å„’é›…çš„å„’è€…ã€‚

è«‹åš´æ ¼æ ¹æ“š Stage1 çš„æ¨ç†æ­¥é©Ÿï¼š
1. å°æ‡‰æ¯ä¸€æ¢ Stepï¼Œæä¾› 1-2 å¥å…·é«”å¯åŸ·è¡Œçš„å»ºè­°
2. å»ºè­°è¦é«”ç¾ã€Œä»ç¾©ã€ã€Œä»¥å¾·æœäººã€ã€Œä¿®èº«ã€çš„æ™ºæ…§
3. æœ€å¾Œå¯«ä¸€æ®µ 3-5 å¥çš„ç¸½çµï¼ˆå¦‚åŒè«–èªçš„é¢¨æ ¼ï¼Œæº«å’Œè€Œæœ‰åŠ›ï¼‰

èªæ°£è¦æº«æ–‡ã€é‡è¦–äººéš›ã€å¼·èª¿è‡ªæˆ‘ä¿®é¤Šã€‚"""
    },
    
    "ç®¡ä»²å¼ï¼ˆæ³•å®¶/å‹™å¯¦ï¼‰": {
        "icon": "âš–ï¸",
        "color": "#009B77",
        "core_concepts": "åˆ¶åº¦ã€åˆ†å·¥ã€æ•ˆç‡ã€çæ‡²åˆ†æ˜ã€å¯Œåœ‹å¼·å…µã€å‹™å¯¦æ²»åœ‹",
        "stage1_system": """ä½ æ˜¯æ¨¡æ“¬ã€Œç®¡ä»²ã€çš„æ™ºæ…§åŠ©æ‰‹ï¼Œåš´æ ¼éµå¾ªæ³•å®¶/å‹™å¯¦æ²»åœ‹æ€æƒ³é€²è¡Œæ€è€ƒã€‚

ç®¡ä»²çš„æ ¸å¿ƒè§€å¿µï¼š
- åˆ¶åº¦åŒ–ï¼šå»ºç«‹æ˜ç¢ºçš„è¦å‰‡èˆ‡æµç¨‹
- åˆ†å·¥æ˜ç¢ºï¼šå„å¸å…¶è·ï¼Œè²¬ä»»æ¸…æ¥š
- æ•ˆç‡å„ªå…ˆï¼šè¿½æ±‚æœ€ä½³æˆæ•ˆ
- çæ‡²åˆ†æ˜ï¼šè³ç½°å¿…ä¿¡
- å¯Œåœ‹å¼·å…µï¼šè³‡æºé…ç½®æœ€å„ªåŒ–
- å‹™å¯¦ä¸»ç¾©ï¼šä¸ç©ºè«‡ï¼Œé‡å¯¦æ•ˆ

è«‹ç”¨å°ç£ç¿’æ…£çš„ä¸­æ–‡å›æ‡‰ã€‚ä½ æ˜¯ä¸€ä½æ·±è«³å‹™å¯¦æ²»åœ‹æ™ºæ…§çš„æ€è€ƒå°å¸«ã€‚
é‡å°ä½¿ç”¨è€…çš„å•é¡Œï¼Œè«‹ä»¥ç®¡ä»²çš„è¦–è§’ï¼Œç”¢ç”Ÿ 4-6 æ¢ã€Œæ¨ç†æ­¥é©Ÿã€ã€‚
æ¯æ¢æ¨ç†è¦é«”ç¾æ³•å®¶çš„æ ¸å¿ƒè§€å¿µï¼ˆåˆ¶åº¦ã€æ•ˆç‡ã€åˆ©å®³åˆ†æï¼‰ï¼Œç”¨æ¢åˆ—æ–¹å¼å‘ˆç¾ï¼Œæ¨™æ˜ Step 1ã€Step 2 ç­‰ã€‚
é€™æ˜¯ç¬¬ä¸€éšæ®µï¼Œåªéœ€ç”¢ç”Ÿæ¨ç†éˆï¼Œä¸è¦çµ¦æœ€çµ‚å»ºè­°ã€‚""",
        
        "stage2_system": """ä½ æ˜¯æ ¹æ“šã€Œç®¡ä»²å¼æ¨ç†éˆã€ç”Ÿæˆå¯¦ç”¨å»ºè­°çš„åŸ·è¡Œè€…ã€‚
è«‹ç”¨å°ç£ç¿’æ…£çš„ä¸­æ–‡å›æ‡‰ï¼Œèªæ°£å¦‚åŒä¸€ä½å‹™å¯¦å¹¹ç·´çš„è¬€å£«ã€‚

è«‹åš´æ ¼æ ¹æ“š Stage1 çš„æ¨ç†æ­¥é©Ÿï¼š
1. å°æ‡‰æ¯ä¸€æ¢ Stepï¼Œæä¾› 1-2 å¥å…·é«”å¯åŸ·è¡Œçš„å»ºè­°
2. å»ºè­°è¦é«”ç¾ã€Œåˆ¶åº¦åŒ–ã€ã€Œæ•ˆç‡ã€ã€Œçæ‡²åˆ†æ˜ã€çš„æ™ºæ…§
3. æœ€å¾Œå¯«ä¸€æ®µ 3-5 å¥çš„ç¸½çµï¼ˆå¦‚åŒçµ¦å›ä¸»çš„ç­–ç•¥å»ºè­°ï¼Œç°¡æ½”æœ‰åŠ›ï¼‰

èªæ°£è¦æœæ–·ã€å‹™å¯¦ã€é‡è¦–å¯æ“ä½œæ€§ã€‚"""
    }
}

# ==================== Groq API å‘¼å«å‡½å¼ ====================
def call_groq(system_prompt: str, user_prompt: str, api_key: str) -> str:
    """å‘¼å« Groq API é€²è¡Œæ¨ç†"""
    try:
        client = Groq(api_key=api_key)
        
        response = client.chat.completions.create(
            model="llama-3.3-70b-versatile",  # ä½¿ç”¨ Groq æ”¯æ´çš„æ¨¡å‹
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": user_prompt}
            ],
            max_tokens=1024,
            temperature=0.7
        )
        
        return response.choices[0].message.content
    
    except Exception as e:
        return f"âŒ API å‘¼å«éŒ¯èª¤ï¼š{str(e)}"

# ==================== Two-Stage CoT ä¸»å‡½å¼ ====================
def ancient_thinker_generate(question: str, thinker_style: str, api_key: str):
    """
    Two-Stage Chain-of-Thought ç”Ÿæˆ
    Stage 1: ç”¢ç”Ÿæ€æƒ³å®¶é¢¨æ ¼çš„æ¨ç†éˆ
    Stage 2: æ ¹æ“šæ¨ç†éˆç”Ÿæˆæœ€çµ‚å»ºè­°
    """
    thinker = THINKERS[thinker_style]
    
    # Stage 1: ç”Ÿæˆæ¨ç†éˆ
    stage1_prompt = f"""ä½¿ç”¨è€…çš„å•é¡Œæ˜¯ï¼šã€Œ{question}ã€

è«‹ä»¥é€™ä½æ€æƒ³å®¶çš„æ ¸å¿ƒè§€å¿µé€²è¡Œæ·±åº¦æ€è€ƒï¼š
{thinker['core_concepts']}

ç”¢ç”Ÿ 4-6 æ¢æ¨ç†æ­¥é©Ÿï¼Œæ¯æ¢æ¨™æ˜ Step ç·¨è™Ÿã€‚"""

    reasoning_chain = call_groq(
        system_prompt=thinker["stage1_system"],
        user_prompt=stage1_prompt,
        api_key=api_key
    )
    
    # Stage 2: æ ¹æ“šæ¨ç†éˆç”Ÿæˆå»ºè­°
    stage2_prompt = f"""ä½¿ç”¨è€…çš„åŸå§‹å•é¡Œï¼šã€Œ{question}ã€

ä»¥ä¸‹æ˜¯ Stage1 ç”¢ç”Ÿçš„æ¨ç†éˆï¼š
{reasoning_chain}

è«‹æ ¹æ“šä¸Šè¿°æ¯ä¸€æ¢æ¨ç†æ­¥é©Ÿï¼Œæä¾›å°æ‡‰çš„å…·é«”å»ºè­°ï¼Œæœ€å¾Œçµ¦å‡ºç¸½çµã€‚"""

    final_advice = call_groq(
        system_prompt=thinker["stage2_system"],
        user_prompt=stage2_prompt,
        api_key=api_key
    )
    
    return reasoning_chain, final_advice

# ==================== Streamlit UI ====================
def main():
    # æ¨™é¡Œå€
    st.title("ğŸ›ï¸ å¤ä»£æ€æƒ³å®¶é¢¨æ ¼çš„ AI æ€è€ƒç”Ÿæˆå™¨")
    st.markdown("""
    ### é‹ç”¨ Two-Stage Chain-of-Thought æŠ€è¡“
    è®“ AI æ¨¡æ“¬ **è€å­**ã€**å­”å­**ã€**ç®¡ä»²** ä¸‰ä½å¤ä»£æ€æƒ³å®¶çš„æ€ç¶­æ–¹å¼ï¼Œ
    ç‚ºä½ çš„å•é¡Œæä¾›ä¸åŒè¦–è§’çš„æ™ºæ…§å»ºè­°ã€‚
    """)
    
    st.divider()
    
    # API Key è¨­å®š
    api_key = get_api_key()
    
    # å´é‚Šæ¬„è¨­å®š
    with st.sidebar:
        st.header("âš™ï¸ è¨­å®š")
        
        # å¦‚æœæ²’æœ‰é è¨­ API Keyï¼Œè®“ä½¿ç”¨è€…è¼¸å…¥
        if not api_key:
            api_key = st.text_input(
                "è«‹è¼¸å…¥ Groq API Key",
                type="password",
                help="å‰å¾€ https://console.groq.com å–å¾— API Key"
            )
        else:
            st.success("âœ… API Key å·²è¨­å®š")
        
        st.divider()
        
        st.markdown("### ğŸ“– æ€æƒ³å®¶ç°¡ä»‹")
        for name, info in THINKERS.items():
            with st.expander(f"{info['icon']} {name}"):
                st.markdown(f"**æ ¸å¿ƒè§€å¿µï¼š**\n\n{info['core_concepts']}")
        
        st.divider()
        st.markdown("""
        ### ğŸ” Two-Stage CoT èªªæ˜
        1. **Stage 1ï¼ˆæ€è€ƒéšæ®µï¼‰**ï¼šAI ä»¥é¸å®šæ€æƒ³å®¶çš„è¦–è§’ï¼Œç”¢ç”Ÿæ¨ç†æ­¥é©Ÿ
        2. **Stage 2ï¼ˆå»ºè­°éšæ®µï¼‰**ï¼šæ ¹æ“šæ¨ç†æ­¥é©Ÿï¼Œç”¢ç”Ÿå…·é«”å¯è¡Œçš„å»ºè­°
        """)
    
    # ä¸»è¦è¼¸å…¥å€
    col1, col2 = st.columns([2, 1])
    
    with col1:
        question = st.text_area(
            "ğŸ’­ è«‹è¼¸å…¥ä½ çš„å•é¡Œæˆ–å›°å¢ƒ",
            placeholder="ä¾‹å¦‚ï¼šæˆ‘è¦å¦‚ä½•è®“æ–°åœ˜éšŠå¿«é€Ÿé‹ä½œèµ·ä¾†ï¼Ÿ",
            height=100
        )
    
    with col2:
        thinker_style = st.radio(
            "ğŸ­ é¸æ“‡æ€æƒ³å®¶é¢¨æ ¼",
            options=list(THINKERS.keys()),
            format_func=lambda x: f"{THINKERS[x]['icon']} {x}"
        )
    
    # ç”ŸæˆæŒ‰éˆ•
    col_btn1, col_btn2, col_btn3 = st.columns([1, 1, 1])
    with col_btn2:
        generate_btn = st.button(
            "ğŸš€ é–‹å§‹ç”Ÿæˆæ™ºæ…§å»ºè­°",
            type="primary",
            use_container_width=True
        )
    
    # åŸ·è¡Œç”Ÿæˆ
    if generate_btn:
        if not api_key:
            st.error("âŒ è«‹å…ˆè¨­å®š Groq API Keyï¼")
        elif not question.strip():
            st.warning("âš ï¸ è«‹è¼¸å…¥å•é¡Œï¼")
        else:
            thinker = THINKERS[thinker_style]
            
            st.divider()
            st.markdown(f"## {thinker['icon']} {thinker_style} çš„æ™ºæ…§å›æ‡‰")
            
            with st.spinner("ğŸ§  Stage 1: æ­£åœ¨é€²è¡Œæ·±åº¦æ€è€ƒ..."):
                reasoning_chain, final_advice = ancient_thinker_generate(
                    question=question,
                    thinker_style=thinker_style,
                    api_key=api_key
                )
            
            # é¡¯ç¤ºçµæœ
            col_result1, col_result2 = st.columns(2)
            
            with col_result1:
                st.markdown("### ğŸ§  Stage 1: æ¨ç†éˆï¼ˆChain-of-Thoughtï¼‰")
                st.info(reasoning_chain)
            
            with col_result2:
                st.markdown("### ğŸ’¡ Stage 2: æ™ºæ…§å»ºè­°")
                st.success(final_advice)
            
            # é¡¯ç¤ºå®Œæˆè¨Šæ¯
            st.divider()
            st.balloons()
            st.markdown(f"""
            ---
            âœ¨ **ç”Ÿæˆå®Œæˆï¼** ä»¥ä¸Šæ˜¯ **{thinker_style}** å°æ–¼ã€Œ{question[:30]}...ã€çš„æ€è€ƒèˆ‡å»ºè­°ã€‚
            
            ğŸ’¡ **æç¤º**ï¼šä½ å¯ä»¥è©¦è©¦é¸æ“‡ä¸åŒçš„æ€æƒ³å®¶ï¼Œæ¯”è¼ƒä»–å€‘å°åŒä¸€å•é¡Œçš„ä¸åŒè§€é»ï¼
            """)
    
    # ç¯„ä¾‹å•é¡Œå€
    st.divider()
    with st.expander("ğŸ“ ç¯„ä¾‹å•é¡Œï¼ˆé»æ“Šå±•é–‹ï¼‰"):
        st.markdown("""
        ä»¥ä¸‹æ˜¯ä¸€äº›é©åˆè©¢å•çš„å•é¡Œç¯„ä¾‹ï¼š
        
        1. ğŸ¢ **åœ˜éšŠç®¡ç†**ï¼šã€Œæˆ‘è¦å¦‚ä½•è®“æ–°åœ˜éšŠå¿«é€Ÿé‹ä½œèµ·ä¾†ï¼Ÿã€
        2. ğŸ¤ **äººéš›è¡çª**ï¼šã€Œé¢å°åœ˜éšŠå…§éƒ¨è¡çªï¼Œæˆ‘æ‡‰è©²æ€éº¼è™•ç†ï¼Ÿã€
        3. ğŸ’° **è³‡æºåˆ†é…**ï¼šã€Œåœ¨æœ‰é™é ç®—ä¸‹ï¼Œå¦‚ä½•æå‡ç”¢å“ä¸Šç·šé€Ÿåº¦ï¼Ÿã€
        4. ğŸ“ˆ **è·æ¶¯ç™¼å±•**ï¼šã€Œæˆ‘è©²å¦‚ä½•åœ¨å…¬å¸ä¸­ç²å¾—å‡é·æ©Ÿæœƒï¼Ÿã€
        5. âš–ï¸ **æ±ºç­–å›°é›£**ï¼šã€Œé¢å°å…©å€‹éƒ½ä¸éŒ¯çš„é¸æ“‡ï¼Œæˆ‘è©²å¦‚ä½•æ±ºå®šï¼Ÿã€
        6. ğŸ¯ **ç›®æ¨™é”æˆ**ï¼šã€Œå¦‚ä½•æœ‰æ•ˆç‡åœ°å®Œæˆä¸€å€‹å¤§å‹å°ˆæ¡ˆï¼Ÿã€
        """)
    
    # é å°¾
    st.divider()
    st.markdown("""
    <div style="text-align: center; color: gray; font-size: 0.8em;">
    ğŸ›ï¸ å¤ä»£æ€æƒ³å®¶ AI æ€è€ƒç”Ÿæˆå™¨ | Two-Stage CoT Demo | Powered by Groq
    </div>
    """, unsafe_allow_html=True)

if __name__ == "__main__":
    main()
